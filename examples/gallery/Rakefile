WAWJS_ROOT = File.expand_path('../../../', __FILE__)
WAWJS = Dir["#{WAWJS_ROOT}/dist/waw-*.js"].last
require 'fileutils'

# Absolutizes a path from here (i.e. __DIR__)
def _(relative) 
  File.expand_path("../#{relative}", __FILE__)
end

begin
  require 'rake/testtask'
  desc "Run unit tests"
  Rake::TestTask.new(:unit_test) do |t|
    t.libs = ["src"]
    t.verbose = false
    # Glob pattern to match test files. (default is 'test/test*.rb')
    t.pattern = "test/*_test.rb"
  end
rescue LoadError => ex
  task :unit_test do
    abort 'rspec is not available. In order to run spec, you must: gem install rspec'
  end
ensure
  desc "Run all tests"
  task :test => [:unit_test]
end


desc "Builds the application (gallery.coffee -> gallery.js)"
task :build do
  
  # Copy the last waw.js version 
  `cd #{WAWJS_ROOT} && cake dist`
  FileUtils.cp WAWJS, _("src/public/js")

  # Compile the client application
  files = ['src/model/model', 'src/see/see', 'src/gallery'].collect{|name|
    _("#{name}.coffee")
  }
  target = _('src/public/js/gallery.js')
  
  cmd = "coffee -b -c -j -o #{File.dirname(target)} #{files.join(' ')}"
  puts "Build .js client: #{cmd}"
  if Kernel.system(cmd)
    FileUtils.mv File.join(File.dirname(target), "concatenation.js"), target
  else
    raise "An error occured when building .js client"
  end
end

desc "Runs the application"
task :"run:sinatra" => :build do
  Kernel.exec "ruby #{_('webapp.rb')}"
end

task :default => :"run:sinatra"